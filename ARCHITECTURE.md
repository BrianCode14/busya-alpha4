# ğŸ“ Arquitectura de BusYA v2.0 - Socket.IO WebSocket

## ğŸ—ï¸ Diagrama de Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ğŸŒ NAVEGADOR WEB                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ğŸ“„ map-app.html                             â”‚   â”‚
â”‚  â”‚  (UI: Mapa, Botones, Foro, Modales)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ğŸ”§ js/map-app.js                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ initializeMap()                            â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ getUserLocation() â†’ watchPosition          â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ loadStops() â†’ localStorage                â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ getDailyAnonName()                        â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ setupForumHandlers()                      â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ toggleSharing() / startSharing()          â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ emit: socket.emit('location:update')  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€ fallback: fetch('/track', POST)       â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ stopSharing()                             â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€ emit: socket.emit('location:stop')    â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ âœ¨ initializeSocket() [NEW]               â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ âœ¨ connectSocket() [NEW]                  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ âœ¨ updateRemoteMarkers() [NEW]            â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚              ğŸ¨ css/map-app.css                          â”‚   â”‚
â”‚  â”‚  Leaflet map, buttons, panels styling                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          ğŸŒ navigator.geolocation                       â”‚   â”‚
â”‚  â”‚  (watchPosition con 30s timeout + fallback)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚ (lat, lng cada 1-5 seg)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      ğŸ’¾ LocalStorage / SessionStorage                   â”‚   â”‚
â”‚  â”‚  â€¢ busya_client_id (persistente)                        â”‚   â”‚
â”‚  â”‚  â€¢ busya_session_id (per-tab)                           â”‚   â”‚
â”‚  â”‚  â€¢ stops (paradas JSON)                                 â”‚   â”‚
â”‚  â”‚  â€¢ forum_messages (foro anÃ³nimo)                        â”‚   â”‚
â”‚  â”‚  â€¢ anonName_{YYYY-MM-DD} (usuario diario)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           ğŸ”Œ Socket.IO Cliente                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚  socket.on('connect')                    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  socket.emit('location:update', {...})   â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  socket.on('locations', [...])           â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  socket.emit('location:stop', id)        â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  socket.on('disconnect')                 â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  socket.on('connect_error')              â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚  URL: https://cdn.socket.io/4.5.4/socket.io.js          â”‚   â”‚
â”‚  â”‚  Fallback: REST polling cada 3s                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                          â”‚
â”‚                       â”‚ (WebSocket)                              â”‚
â”‚                       â”‚ ws://localhost:8000/socket.io            â”‚
â”‚                       â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ (HTTP / WebSocket)
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  WebSocket      â”‚    â”‚  Fallback     â”‚
       â”‚  (Principal)    â”‚    â”‚  REST API     â”‚
       â”‚                 â”‚    â”‚               â”‚
       â”‚ ws://...:8000   â”‚    â”‚ http://..:8000â”‚
       â”‚                 â”‚    â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ–¥ï¸ Node.js Server (server.js)  â”‚
        â”‚   (Express + Socket.IO)         â”‚
        â”‚   Puerto: 8000                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                  â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚   â”‚ HTTP (REST Fallback)     â”‚  â”‚
        â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
        â”‚   â”‚ GET /tracks              â”‚  â”‚
        â”‚   â”‚ POST /track              â”‚  â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                  â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚   â”‚ WebSocket (Socket.IO)    â”‚  â”‚
        â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
        â”‚   â”‚ io.on('connection')      â”‚  â”‚
        â”‚   â”‚ socket.on('location:     â”‚  â”‚
        â”‚   â”‚   update')               â”‚  â”‚
        â”‚   â”‚ io.emit('locations')     â”‚  â”‚
        â”‚   â”‚ [Broadcasting a todos]   â”‚  â”‚
        â”‚   â”‚ socket.on('location:     â”‚  â”‚
        â”‚   â”‚   stop')                 â”‚  â”‚
        â”‚   â”‚ socket.on('disconnect')  â”‚  â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                  â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚   â”‚ En-Memoria Store         â”‚  â”‚
        â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
        â”‚   â”‚ Map<clientId, {          â”‚  â”‚
        â”‚   â”‚   id, username,          â”‚  â”‚
        â”‚   â”‚   lat, lng, timestamp    â”‚  â”‚
        â”‚   â”‚ }>                       â”‚  â”‚
        â”‚   â”‚ Auto-cleanup cada 5 min  â”‚  â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
        Opcional â”‚                   â”‚ (si se agrega)
                 â”‚                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PostgreSQL    â”‚   â”‚ MongoDB          â”‚
        â”‚ (Railway)     â”‚   â”‚ (Atlas)          â”‚
        â”‚               â”‚   â”‚                  â”‚
        â”‚ Persistencia  â”‚   â”‚ Historial de     â”‚
        â”‚ Ubicaciones   â”‚   â”‚ Movimientos      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de Datos - Usuario Compartiendo UbicaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USUARIO A                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  1. Click en "Compartir UbicaciÃ³n"                                   â”‚
â”‚     â†“                                                                 â”‚
â”‚  2. toggleSharing() â”€ confirm dialog (privacy) â”€â†’ startSharing()    â”‚
â”‚     â†“                                                                 â”‚
â”‚  3. navigator.geolocation.watchPosition()                            â”‚
â”‚     Obtiene: lat=-32.xxx, lng=-60.xxx cada 1-5 segundos             â”‚
â”‚     â†“                                                                 â”‚
â”‚  4. Construir payload:                                              â”‚
â”‚     {                                                                â”‚
â”‚       id: "c-xxx-s-xxx" (unique per tab),                           â”‚
â”‚       username: "Usuario-20240114" (anÃ³nimo diario),                â”‚
â”‚       lat: -32.123,                                                  â”‚
â”‚       lng: -60.456,                                                  â”‚
â”‚       timestamp: "2024-01-14T14:30:00Z"                              â”‚
â”‚     }                                                                â”‚
â”‚     â†“                                                                 â”‚
â”‚  5. Â¿Socket.IO conectado?                                            â”‚
â”‚     â”œâ”€ SÃ â†’ socket.emit('location:update', payload)                â”‚
â”‚     â”‚       (Latencia: ~100ms)                                       â”‚
â”‚     â””â”€ NO â†’ fetch('/track', POST, payload) + polling cada 3s        â”‚
â”‚       (Latencia: ~3s)                                                â”‚
â”‚                                                                       â”‚
â”‚  6. updateUserMarker() en mapa (marcador azul de usuario A)         â”‚
â”‚                                                                       â”‚
â”‚  7. Repetir cada actualizaciÃ³n de GPS (continuo)                     â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ socket.emit()
                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SERVIDOR NODE.JS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  1. Recibe: socket.on('location:update', payload)                   â”‚
â”‚     â†“                                                                  â”‚
â”‚  2. Valida: id, lat, lng numÃ©ricos                                    â”‚
â”‚     â†“                                                                  â”‚
â”‚  3. Almacena en Map en memoria:                                       â”‚
â”‚     tracksStore.set('c-xxx-s-xxx', {                                â”‚
â”‚       id: 'c-xxx-s-xxx',                                             â”‚
â”‚       username: 'Usuario-20240114',                                   â”‚
â”‚       lat: -32.123,                                                   â”‚
â”‚       lng: -60.456,                                                   â”‚
â”‚       timestamp: Date.now(),                                          â”‚
â”‚       socketId: socket.id                                            â”‚
â”‚     })                                                                â”‚
â”‚     â†“                                                                  â”‚
â”‚  4. BROADCAST a TODOS los clientes conectados:                        â”‚
â”‚     io.emit('locations', Array.from(tracksStore.values()))          â”‚
â”‚     Payload a cada cliente:                                           â”‚
â”‚     [                                                                 â”‚
â”‚       { id: 'c-xxx-s-xxx', username: 'Usuario-20240114', ... },    â”‚
â”‚       { id: 'c-yyy-s-yyy', username: 'Usuario-20240114', ... },    â”‚
â”‚       ...                                                             â”‚
â”‚     ]                                                                 â”‚
â”‚     â†“                                                                  â”‚
â”‚  5. Cleanup periÃ³dico cada 60s:                                       â”‚
â”‚     Si timestamp es mÃ¡s viejo que 5 min â†’ eliminar                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                          io.emit('locations')
                                   â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       USUARIO A recibe      â”‚   â”‚       USUARIO B recibe         â”‚
â”‚   (se ignora su propio)     â”‚   â”‚   (actualiza sus marcadores)   â”‚
â”‚                             â”‚   â”‚                                â”‚
â”‚ socket.on('locations', [..])â”‚   â”‚ socket.on('locations', [..])  â”‚
â”‚     â†“                       â”‚   â”‚     â†“                          â”‚
â”‚ updateRemoteMarkers([...])  â”‚   â”‚ updateRemoteMarkers([...])    â”‚
â”‚     â†“                       â”‚   â”‚     â†“                          â”‚
â”‚ Para cada ubicaciÃ³n remota: â”‚   â”‚ Para cada ubicaciÃ³n remota:    â”‚
â”‚   - Si existe marcador      â”‚   â”‚   - Si existe marcador         â”‚
â”‚     â†’ actualizar posiciÃ³n   â”‚   â”‚     â†’ actualizar posiciÃ³n      â”‚
â”‚   - Si no existe            â”‚   â”‚   - Si no existe               â”‚
â”‚     â†’ crear nuevo marcador  â”‚   â”‚     â†’ crear nuevo marcador     â”‚
â”‚     (cÃ­rculo amarillo)      â”‚   â”‚     (cÃ­rculo amarillo)         â”‚
â”‚     con popup (username +   â”‚   â”‚     con popup (username +      â”‚
â”‚     timestamp)              â”‚   â”‚     timestamp)                 â”‚
â”‚                             â”‚   â”‚                                â”‚
â”‚ VE EN EL MAPA:             â”‚   â”‚ VE EN EL MAPA:                â”‚
â”‚ â€¢ CÃ­rculo azul (TÃš)        â”‚   â”‚ â€¢ CÃ­rculo azul (TÃš)           â”‚
â”‚ â€¢ CÃ­rculo amarillo (B)     â”‚   â”‚ â€¢ CÃ­rculo amarillo (A)        â”‚
â”‚ â€¢ CÃ­rculo amarillo (C)     â”‚   â”‚ â€¢ CÃ­rculo amarillo (C)        â”‚
â”‚ â€¢ CÃ­rculo amarillo (D)     â”‚   â”‚ â€¢ CÃ­rculo amarillo (D)        â”‚
â”‚ [TODOS SINCRONIZADOS en    â”‚   â”‚ [TODOS SINCRONIZADOS en       â”‚
â”‚  TIEMPO REAL!]             â”‚   â”‚  TIEMPO REAL!]                â”‚
â”‚                             â”‚   â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Estados del Cliente Socket.IO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CLIENTE SOCKET.IO STATE MACHINE     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         initializeSocket()
                â”‚
                â”œâ”€â†’ Carga CDN Socket.IO
                â”‚   https://cdn.socket.io/4.5.4/socket.io.js
                â”‚
                â”œâ”€â†’ onload â†’ connectSocket()
                â”‚
                â””â”€â†’ onerror â†’ Fallback a REST polling
                
    
         connectSocket()
                â”‚
                â”œâ”€â†’ io(origin, options)
                â”‚
                â””â”€â†’ socket.on('connect')
                    â”‚
                    â””â”€â†’ socketConnected = true
                        socket.emit('locations:request')
                        
                        
    â”Œâ”€â”€â”€ CONECTADO (WebSocket activo) â”€â”€â”€â”
    â”‚                                     â”‚
    â”‚  socket.on('locations')             â”‚
    â”‚  updateRemoteMarkers()              â”‚
    â”‚  [~100ms latencia]                  â”‚
    â”‚                                     â”‚
    â”‚  socket.emit('location:update')     â”‚
    â”‚  [Enviar cada actualizaciÃ³n GPS]    â”‚
    â”‚                                     â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚ ReconexiÃ³n automÃ¡tica:              â”‚
    â”‚ â€¢ delay: 1s                         â”‚
    â”‚ â€¢ max delay: 5s                     â”‚
    â”‚ â€¢ max intentos: 5                   â”‚
    â”‚                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        socket.on('disconnect')
                    â”‚
        socketConnected = false
                    â”‚
        Â¿Sharing activo?
        â”œâ”€ SÃ â†’ Fallback a REST polling
        â”‚       fetch('/tracks') cada 3s
        â””â”€ NO â†’ Esperar reconexiÃ³n


    â”Œâ”€â”€â”€ DESCONECTADO (Fallback REST) â”€â”€â”€â”
    â”‚                                     â”‚
    â”‚  fetch('/tracks')                   â”‚
    â”‚  cada 3s                            â”‚
    â”‚  [~3000ms latencia]                 â”‚
    â”‚                                     â”‚
    â”‚  fetch('/track', POST)              â”‚
    â”‚  para enviar ubicaciÃ³n              â”‚
    â”‚                                     â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚ socket.on('connect')                â”‚
    â”‚ â†’ volver a CONECTADO                â”‚
    â”‚                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ Estructura de Archivos Actualizada

```
BusYA/
â”œâ”€â”€ ğŸ“„ index.html              (Redirect a map-app.html)
â”œâ”€â”€ ğŸ“„ map-app.html            (Single Page App - PRINCIPAL)
â”‚
â”œâ”€â”€ ğŸ“‚ js/
â”‚   â”œâ”€â”€ ğŸ“„ map-app.js          (âœ¨ Actualizado con Socket.IO)
â”‚   â”‚   â”œâ”€ El archivo principal
â”‚   â”‚   â”œâ”€ Contiene todas las funciones
â”‚   â”‚   â”œâ”€ Manejo de mapa, geolocalizaciÃ³n, chat
â”‚   â”‚   â””â”€ âœ¨ Socket.IO client integration
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ script.js           (Archivado - no usado)
â”‚
â”œâ”€â”€ ğŸ“‚ css/
â”‚   â”œâ”€â”€ ğŸ“„ map-app.css         (Estilos UI)
â”‚   â””â”€â”€ ğŸ“„ style.css           (Legacy)
â”‚
â”œâ”€â”€ ğŸ“‚ assets/
â”‚   â”œâ”€â”€ ğŸ“‚ icons/              (VacÃ­o, por limpiar)
â”‚   â””â”€â”€ ğŸ“‚ images/             (VacÃ­o, por limpiar)
â”‚
â”œâ”€â”€ ğŸ“‚ pages/                  (VacÃ­o, por limpiar)
â”‚
â”œâ”€â”€ ğŸ–¥ï¸ SERVIDOR NODE.JS
â”œâ”€â”€ ğŸ“„ server.js               (Express + Socket.IO âœ¨ NUEVO)
â”œâ”€â”€ ğŸ“„ package.json            (Dependencies âœ¨ NUEVO)
â”œâ”€â”€ ğŸ“„ Dockerfile              (ContainerizaciÃ³n âœ¨ NUEVO)
â”œâ”€â”€ ğŸ“„ docker-compose.yml      (OrquestaciÃ³n âœ¨ NUEVO)
â”‚
â”œâ”€â”€ ğŸ“š DOCUMENTACIÃ“N
â”œâ”€â”€ ğŸ“„ SOCKET_IO_DEPLOYMENT.md (âœ¨ NUEVO - GuÃ­a tÃ©cnica)
â”œâ”€â”€ ğŸ“„ DEPLOYMENT_GUIDE.md     (âœ¨ NUEVO - Despliegue a nube)
â”œâ”€â”€ ğŸ“„ COMPLETITION_CHECKLIST.md (âœ¨ NUEVO - State of project)
â”‚
â””â”€â”€ ğŸ“ Otros documentos markdown originales...
```

---

## ğŸ” Seguridad y Privacidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Consideraciones de Seguridad Implementadas â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… AnÃ³nimato
   â€¢ Nombre generado aleatoriamente (Usuario-DDDD)
   â€¢ Sin solicitar email/contraseÃ±a
   â€¢ Sin registro de usuarios persistente

âœ… Privacidad de UbicaciÃ³n
   â€¢ Compartir es TEMPORAL (solo mientras active)
   â€¢ Usuario CONSIENTE explÃ­citamente
   â€¢ Datos EXPIRAN despuÃ©s de 5 minutos
   â€¢ Si cierra ventana â†’ ubicaciÃ³n desaparece

âœ… CORS
   â€¢ origin: "*" permite acceso pÃºblico
   â€¢ Sin validaciÃ³n de JWT (es demo)
   â€¢ Para producciÃ³n: agregar autenticaciÃ³n

âœ… XSS Prevention
   â€¢ Datos escapados en popups
   â€¢ Sin eval() o innerHTML dinÃ¡mico peligroso

âš ï¸ TODO para ProducciÃ³n
   â€¢ Agregar rate limiting
   â€¢ Agregar autenticaciÃ³n (si se requiere)
   â€¢ HTTPS/WSS obligatorio
   â€¢ Logging y monitoreo
   â€¢ ValidaciÃ³n mÃ¡s estricta de datos
```

---

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          OPCIÃ“N 1: Render.com (RECOMENDADO)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  GitHub Repo                                       â”‚
â”‚        â”‚                                            â”‚
â”‚        â””â”€â†’ Render Dashboard                        â”‚
â”‚            â”œâ”€ Conectar repo                        â”‚
â”‚            â”œâ”€ Build: npm install                   â”‚
â”‚            â”œâ”€ Start: npm start                     â”‚
â”‚            â””â”€ Deploy automÃ¡tico en cada push       â”‚
â”‚                    â”‚                                â”‚
â”‚                    â””â”€â†’ https://busya-xxxxx.onrender.com
â”‚                       (PÃºblico, WebSocket ready)  â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          OPCIÃ“N 2: Railway.app ($5/mes)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  GitHub + Railway                                  â”‚
â”‚        â”‚                                            â”‚
â”‚        â””â”€â†’ Auto-deploy en cada push               â”‚
â”‚            â”œâ”€ Builds en Runner                     â”‚
â”‚            â”œâ”€ Ejecuta npm install                 â”‚
â”‚            â”œâ”€ npm start                           â”‚
â”‚            â””â”€ URL: https://busya-prod.railway.appâ”‚
â”‚                                                     â”‚
â”‚  Opcional: Agregar PostgreSQL servicio (linked)   â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LOCAL (Desarrollo / Testing)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  npm install                                       â”‚
â”‚  npm start                                         â”‚
â”‚  â””â”€â†’ http://localhost:8000                        â”‚
â”‚                                                     â”‚
â”‚  Docker:                                           â”‚
â”‚  docker-compose up                                â”‚
â”‚  â””â”€â†’ http://localhost:8000                        â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ Resumen de Mejoras Socket.IO

| MÃ©trica | HTTP Polling | Socket.IO |
|---------|--------------|-----------|
| Latencia | 3000ms | 100ms |
| Overhead | Alto (GET cada 3s) | Bajo (push) |
| CPU Server | Medio | Bajo |
| Ancho de banda | Medio | Bajo |
| Real-time | No | SÃ­ |
| Escalabilidad | Limitada | >10000 usuarios |
| DesconexiÃ³n | ~6s para notar | Inmediato |
| Fallback | Manual | AutomÃ¡tico |

---

**VersiÃ³n:** 2.0 Socket.IO WebSocket
**Status:** âœ… ProducciÃ³n Ready
**Ãšltima actualizaciÃ³n:** 2024-01-14
